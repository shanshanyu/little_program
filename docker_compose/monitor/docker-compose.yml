---
# 新版本已经不需要version字段，默认用最新
services:

  thanos-receiver:
    image: thanosio/thanos:v0.32.1
    container_name: thanos-receiver
    command:
      - receive
      - --grpc-address=0.0.0.0:10901
      - --http-address=0.0.0.0:10902
      - --remote-write.address=0.0.0.0:10903
      - --tsdb.path=/thanos-receive-data
      - --label=receive_replica="receiver-1"
    volumes:
      - thanos_receiver_data:/thanos-receive-data
    ports:
      - "10901:10901"  # gRPC (Query 访问)
      - "10902:10902"  # HTTP (状态页)
      - "10903:10903"  # 远程写入端口
    restart: unless-stopped

  thanos-query:
    image: thanosio/thanos:v0.32.1
    container_name: thanos-query
    command:
      - query
      - --http-address=0.0.0.0:10904
      - --store=172.19.249.108:10901
      - --store=172.19.249.108:10906  # 添加Ruler作为数据源
    ports:
      - "10904:10904"  # Web UI
    restart: unless-stopped
    depends_on:
      - thanos-receiver

  thanos-ruler:
    image: thanosio/thanos:v0.32.1
    container_name: thanos-ruler
    command:
      - rule
      - --http-address=0.0.0.0:10905
      - --grpc-address=0.0.0.0:10906
      - --query=thanos-query:10904  # 查询数据源
      - --label=rule_replica="ruler-1"
      - --data-dir=/thanos-ruler-data
      - --rule-file=/etc/thanos/rules/*.yml  # 规则文件路径
    volumes:
      - ./thanos-rules:/etc/thanos/rules  # 挂载规则文件目录
      - thanos_ruler_data:/thanos-ruler-data
    ports:
      - "10905:10905"  # HTTP UI
      - "10906:10906"  # gRPC
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    command:
      - "grafana"
      - "server"
      - "--config=/etc/grafana/grafana.ini"  # 默认就是此路径，无需修改
      - "--homepath=/usr/share/grafana"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana-provisioning:/etc/grafana/provisioning  # 预配置数据源
    ports:
      - "3000:3000"
    restart: unless-stopped
    depends_on:
      - thanos-query

volumes:
  thanos_receiver_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /thanos-receive-data
  grafana_data:
  thanos_ruler_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /thanos-ruler-data


